name: Deploy to VPS

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: PROD

    steps:
      - name: Setup and validate SSH key
        run: |
          mkdir -p $HOME/.ssh
          # Guardar la clave preservando saltos de l√≠nea correctamente
          printf '%s\n' "${{ secrets.VPS_SSH_KEY }}" > $HOME/.ssh/vps_key
          chmod 600 $HOME/.ssh/vps_key
          # Validar formato b√°sico
          if ! grep -q "BEGIN.*PRIVATE KEY" $HOME/.ssh/vps_key; then
            echo "‚ùå Error: La clave SSH no tiene el formato correcto"
            echo "Primeras l√≠neas del archivo:"
            head -3 $HOME/.ssh/vps_key
            exit 1
          fi
          echo "‚úÖ Clave SSH validada (tama√±o: $(wc -c < $HOME/.ssh/vps_key) bytes)"
          echo "SSH_KEY_PATH=$HOME/.ssh/vps_key" >> $GITHUB_ENV

      - name: Verificar Traefik y red
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key_path: ${{ env.SSH_KEY_PATH }}
          command_timeout: 2m
          script: |
            echo "üîç Verificando Traefik..."
            if ! docker ps | grep -q traefik; then
              echo "‚ö†Ô∏è Traefik no est√° corriendo"
            else
              echo "‚úÖ Traefik est√° corriendo"
              echo "üîç Verificando puertos de Traefik:"
              docker ps | grep traefik
              echo ""
              echo "üîç Verificando si Traefik escucha en puerto 80:"
              docker ps | grep traefik | grep -E "0.0.0.0:80->" && echo "‚úÖ Traefik est√° escuchando en puerto 80" || echo "‚ùå Traefik NO est√° escuchando en puerto 80"
              echo ""
              echo "üîç Verificando si Traefik escucha en puerto 443:"
              docker ps | grep traefik | grep -E "0.0.0.0:443->" && echo "‚úÖ Traefik est√° escuchando en puerto 443" || echo "‚ö†Ô∏è Traefik no escucha en puerto 443"
            fi

            echo "üîç Verificando red traefik_network..."
            if ! docker network ls | grep -q traefik_network; then
              echo "üì¶ Creando red traefik_network..."
              docker network create traefik_network
            else
              echo "‚úÖ Red traefik_network existe"
            fi

      - name: Deploy via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key_path: ${{ env.SSH_KEY_PATH }}
          command_timeout: 10m
          script: |
            # Crear directorio si no existe
            mkdir -p ~/apps

            # Clonar o actualizar repositorio
            if [ ! -d ~/apps/divipola-api ]; then
              echo "üì¶ Clonando repositorio..."
              cd ~/apps
              git clone https://github.com/sebastian-ksk/divipola-api.git
              cd divipola-api
            else
              echo "üîÑ Actualizando repositorio..."
              cd ~/apps/divipola-api
              git fetch origin
              git reset --hard origin/main
            fi

            # Verificar que docker-compose.yml existe
            if [ ! -f docker-compose.yml ]; then
              echo "‚ùå Error: docker-compose.yml no encontrado"
              exit 1
            fi

            # Crear .env si no existe
            if [ ! -f .env ]; then
              echo "üìù Creando archivo .env..."
              echo "DATOS_GOV_APP_TOKEN=" > .env
              echo "‚ö†Ô∏è IMPORTANTE: Configura DATOS_GOV_APP_TOKEN en el archivo .env"
            else
              echo "‚úÖ Archivo .env existe"
            fi

            # Detener contenedores existentes
            docker compose -f docker-compose.yml down 2>/dev/null || true

            # Construir y levantar contenedores
            echo "üî® Construyendo y levantando contenedores..."
            docker compose -f docker-compose.yml up -d --build --remove-orphans

            # Limpiar im√°genes sin usar
            docker image prune -f

            echo "‚úÖ Deploy completado"
            echo "üîÑ Forzando recarga de Traefik..."
            docker restart traefik 2>/dev/null || echo "‚ö†Ô∏è No se pudo reiniciar Traefik"
            echo ""
            echo "üìã Verificando que el contenedor est√° en la red traefik_network:"
            docker inspect divipola_api --format '{{range $net, $conf := .NetworkSettings.Networks}}{{$net}} {{end}}' 2>/dev/null || echo "‚ö†Ô∏è Contenedor a√∫n no est√° disponible"

      - name: Wait and show logs
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key_path: ${{ env.SSH_KEY_PATH }}
          command_timeout: 5m
          script: |
            echo "‚è≥ Esperando 15 segundos..."
            sleep 15
            echo "üìã Estado del contenedor:"
            docker ps | grep divipola_api || echo "‚ùå Contenedor no encontrado"
            echo ""
            echo "üìã √öltimos logs:"
            docker logs --tail 50 divipola_api 2>&1 || echo "‚ùå No se pudieron obtener logs"
            echo ""
            echo "üîç Verificando conexi√≥n a Traefik:"
            docker network inspect traefik_network --format '{{range .Containers}}{{.Name}} {{end}}' || echo "‚ùå Error al inspeccionar red"
            echo ""
            echo "üìã Logs de Traefik (√∫ltimas 20 l√≠neas):"
            docker logs --tail 20 traefik 2>&1 || echo "‚ö†Ô∏è No se pudieron obtener logs de Traefik"
            echo ""
            echo "üîç Verificando si Traefik detecta divipola-api:"
            docker logs traefik 2>&1 | grep -i "divipola" | tail -5 || echo "‚ö†Ô∏è No se encontraron referencias a divipola en logs de Traefik"
            echo ""
            echo "üîç Probando conexi√≥n desde Traefik al contenedor:"
            docker exec traefik wget -q -O- --timeout=2 http://divipola_api:8000/health 2>&1 | head -3 || echo "‚ö†Ô∏è Traefik no puede alcanzar divipola_api:8000"
            echo ""
            echo "üîç Verificando routers de Traefik para divipola-api:"
            docker exec traefik wget -q -O- http://localhost:8080/api/http/routers 2>/dev/null | grep -i "divipola" || echo "‚ö†Ô∏è No se encontraron routers en Traefik API"
            echo ""
            echo "üîç Verificando servicios de Traefik:"
            docker exec traefik wget -q -O- http://localhost:8080/api/http/services 2>/dev/null | grep -i "divipola" || echo "‚ö†Ô∏è No se encontraron servicios en Traefik API"
            echo ""
            echo "üîç Verificando labels del contenedor divipola_api:"
            docker inspect divipola_api --format '{{range .Config.Labels}}{{.}}{{"\n"}}{{end}}' | grep traefik || echo "‚ö†Ô∏è No se encontraron labels de Traefik"
            echo ""
            echo "üîç Verificando IP del contenedor en traefik_network:"
            docker inspect divipola_api --format '{{range $net, $conf := .NetworkSettings.Networks}}{{if eq $net "traefik_network"}}IP: {{$conf.IPAddress}}{{end}}{{end}}' || echo "‚ö†Ô∏è Error al obtener IP"
            echo ""
            echo "üîç Verificando DNS del dominio:"
            nslookup sebastianlabs.tech 2>/dev/null || dig sebastianlabs.tech +short 2>/dev/null || echo "‚ö†Ô∏è No se pudo verificar DNS"
            echo ""
            echo "üîç Verificando firewall (ufw):"
            sudo ufw status 2>/dev/null || echo "‚ö†Ô∏è ufw no est√° disponible o requiere permisos"
            echo ""
            echo "üîç Verificando certificado SSL del dominio:"
            curl -s -o /dev/null -w "HTTP Status: %{http_code}\n" -k -m 5 https://sebastianlabs.tech/api/divipola 2>&1 || echo "‚ö†Ô∏è No se pudo verificar HTTPS del dominio"
